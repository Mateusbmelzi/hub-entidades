# Resumo Final: Separa√ß√£o de Eventos e Reservas

## ‚úÖ IMPLEMENTADO AUTOMATICAMENTE

### 1. Banco de Dados
- ‚úÖ Migra√ß√£o SQL criada: `supabase/migrations/20250110_add_reserva_id_to_eventos.sql`
- ‚úÖ Script de aplica√ß√£o: `apply-separar-eventos-reservas.sql`
- ‚úÖ Campo `eventos.reserva_id` (UUID, nullable, FK para reservas)
- ‚úÖ √çndice `idx_eventos_reserva` para performance
- ‚úÖ RLS Policies atualizadas:
  - Eventos p√∫blicos: Aprovado E (sem reserva OU reserva aprovada)
  - Entidades veem pr√≥prios eventos independente do status
  - Pol√≠ticas de INSERT, UPDATE, DELETE por entidade

### 2. Hooks Criados
- ‚úÖ `src/hooks/useVincularEventoReserva.ts`
  - vincularEventoReserva()
  - desvincularEventoReserva()
  - Estados de loading e error handling

- ‚úÖ `src/hooks/useEventosSemReserva.ts`
  - Busca eventos aprovados SEM reserva de uma entidade

- ‚úÖ `src/hooks/useReservasSemEvento.ts`
  - Busca reservas aprovadas SEM evento de uma entidade

### 3. Componentes Criados
- ‚úÖ `src/components/VincularEventoReserva.tsx`
  - UI para vincular evento ‚Üî reserva
  - UI para desvincular
  - Valida√ß√µes e confirma√ß√µes
  - Suporta ambos fluxos (de evento ou de reserva)

- ‚úÖ `src/components/PreencherReservaComEvento.tsx`
  - Select de eventos aprovados
  - Bot√£o "Aplicar dados do evento"
  - Preenche automaticamente: t√≠tulo, descri√ß√£o, data, hor√°rios, pessoas

- ‚úÖ `src/components/EventosReservasTabsEntidade.tsx`
  - Tabs separadas para Eventos e Reservas
  - Badges de status visuais
  - Bot√µes de vincular/desvincular
  - Integra√ß√£o com dialogs
  - Pronto para usar em EntidadeDetalhes

### 4. Utilit√°rios
- ‚úÖ `src/lib/evento-reserva-status.tsx`
  - getStatusBadgeEvento() - Badges para eventos
  - getStatusBadgeReserva() - Badges para reservas
  - eventoNecessitaReserva() - L√≥gica de valida√ß√£o
  - reservaPodeSerVinculada() - Helper de valida√ß√£o

### 5. Componentes Atualizados
- ‚úÖ `src/components/ReservaSalaFormV2.tsx`
  - Integrado PreencherReservaComEvento no step 1
  - Handler handleAplicarDadosEvento
  - Preenche automaticamente todos os campos

- ‚úÖ `src/components/ReservaAuditorioFormV3.tsx`
  - Integrado PreencherReservaComEvento no step 1
  - Handler handleAplicarDadosEvento
  - Preenche t√≠tulo + descri√ß√£o programa√ß√£o + dados b√°sicos

- ‚úÖ `src/components/CriarEventoEntidade.tsx`
  - Adicionado switch "Este evento precisa de espa√ßo f√≠sico?"
  - State `precisaReserva`
  - Card informativo com switch
  - Mensagem explicativa

- ‚úÖ `src/hooks/useEventos.ts`
  - Mudado JOIN de `!inner` para `!left` (inclui eventos sem reserva)
  - Adicionado `status_reserva` no SELECT
  - Filtro aplicado: apenas eventos sem reserva OU com reserva aprovada
  - Mant√©m cache e pagina√ß√£o funcionando

## üîß A√á√ïES MANUAIS NECESS√ÅRIAS

### 1. Executar Migra√ß√µes SQL (OBRIGAT√ìRIO)

**Arquivo 1:** `apply-separar-eventos-reservas.sql`
- Adiciona campo `reserva_id` em eventos
- Atualiza RLS policies
- Necess√°rio para todo o sistema funcionar

**Arquivo 2:** `fix-aprovar-evento-final.sql`
- Corrige recurs√£o infinita na fun√ß√£o `aprovar_evento`
- Necess√°rio para aprovar eventos sem erro

**Como executar:**
1. Supabase Dashboard ‚Üí SQL Editor
2. New Query
3. Copiar conte√∫do do arquivo
4. Run

### 2. Integrar EventosReservasTabsEntidade em EntidadeDetalhes.tsx

**Arquivo:** `src/pages/EntidadeDetalhes.tsx` (linha ~849)

**Op√ß√£o Simples (Recomendada):**

Adicionar import:
```tsx
import { EventosReservasTabsEntidade } from '@/components/EventosReservasTabsEntidade';
```

Localizar a se√ß√£o de "Eventos" e substituir o Card inteiro por:

```tsx
{isOwner && entidade && (
  <Card className="border-0 shadow-lg bg-white hover:shadow-xl transition-shadow duration-300">
    <CardHeader className="pb-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-2">
          <Calendar className="w-5 h-5 text-red-600" />
          <CardTitle className="text-2xl text-gray-900">Eventos e Reservas</CardTitle>
        </div>
        <Button size="sm" variant="outline" onClick={() => navigate(`/entidades/${id}/calendario`)}>
          <Calendar className="mr-2 h-4 w-4" />
          Ver calend√°rio
        </Button>
      </div>
    </CardHeader>
    
    <CardContent>
      <EventosReservasTabsEntidade
        eventos={allEventos || []}
        reservas={reservasEntidade || []}
        entidadeId={entidade.id}
        isOwner={isOwner}
        onRefetch={() => {
          refetchEventos();
          refetchReservas();
        }}
        onEditEvent={handleEditEvent}
        onDeleteEvent={handleDeleteEvent}
      />
    </CardContent>
  </Card>
)}
```

**Instru√ß√µes detalhadas:** Ver arquivo `GUIA-INTEGRACAO-TABS-ENTIDADE.md`

### 3. Atualizar Tipos Supabase (se necess√°rio)

Ap√≥s executar a migra√ß√£o SQL, pode ser necess√°rio atualizar os tipos:

```bash
npx supabase gen types typescript --linked > src/integrations/supabase/types.ts
```

Ou adicione manualmente em `src/integrations/supabase/types.ts`:

```tsx
eventos: {
  Row: {
    // ... campos existentes
    reserva_id: string | null;
  }
}
```

## üéØ FLUXOS IMPLEMENTADOS

### Fluxo 1: Evento sem reserva (online/externo) ‚úÖ
1. Entidade cria evento
2. Desmarca "precisa espa√ßo f√≠sico"
3. Admin aprova evento
4. Evento aparece publicamente
5. Badge: "Aguardando Reserva" (amarelo)

### Fluxo 2: Criar reserva ‚Üí Vincular evento ‚úÖ
1. Entidade cria reserva
2. Admin aprova reserva
3. Entidade cria evento
4. Admin aprova evento
5. Em EntidadeDetalhes ‚Üí Tab Eventos ‚Üí "Vincular a Reserva"
6. Evento aparece publicamente
7. Badge: "Evento Ativo" (verde)

### Fluxo 3: Criar evento ‚Üí Preencher reserva ‚úÖ
1. Entidade cria evento
2. Admin aprova evento
3. Entidade vai criar reserva
4. No formul√°rio, clica "Preencher com dados de evento"
5. Campos preenchidos automaticamente
6. Admin aprova reserva
7. Entidade vincula em EntidadeDetalhes
8. Badge: "Evento Ativo" (verde)

### Fluxo 4: Fluxo atual (criar evento de reserva) ‚úÖ
1. Entidade cria reserva
2. Admin aprova
3. Entidade clica "Criar Evento" na reserva
4. Sistema cria e vincula automaticamente
5. Admin aprova evento
6. Badge: "Evento Ativo" (verde)

### Fluxo 5: Trocar reserva de evento ‚úÖ
1. Evento vinculado √† Reserva A
2. Em EntidadeDetalhes ‚Üí "Gerenciar Vincula√ß√£o"
3. Desvincular
4. Reserva A fica livre (Badge: "Dispon√≠vel")
5. Vincular a Reserva B
6. Badge: "Evento Ativo" (verde)

## üìä BADGES DE STATUS IMPLEMENTADOS

### Eventos:
- üü¢ **Evento Ativo**: Aprovado + Reserva Aprovada ‚Üí Aparece publicamente
- üü° **Aguardando Reserva**: Aprovado + Sem Reserva ‚Üí N√£o aparece publicamente (exceto se for online/externo)
- üü† **Reserva Pendente**: Aprovado + Reserva Pendente ‚Üí N√£o aparece publicamente
- ‚ö´ **Aguardando Aprova√ß√£o**: Evento Pendente ‚Üí N√£o aparece publicamente
- üî¥ **Rejeitado**: Evento Rejeitado ‚Üí Nunca aparece

### Reservas:
- üîµ **Dispon√≠vel**: Aprovada + Sem Evento ‚Üí Pode ser vinculada
- üü¢ **Reserva Ativa**: Aprovada + Com Evento ‚Üí Em uso
- üü° **Aguardando Aprova√ß√£o**: Pendente ‚Üí Aguardando admin
- üî¥ **Rejeitada**: Rejeitada ‚Üí N√£o pode ser usada
- ‚ö´ **Cancelada**: Cancelada ‚Üí N√£o pode ser usada

## üß™ CHECKLIST DE TESTE

Ap√≥s executar as migra√ß√µes SQL:

- [ ] Criar evento sem marcar "precisa espa√ßo f√≠sico"
- [ ] Admin aprovar evento
- [ ] Evento aparece em lista p√∫blica
- [ ] Badge mostra "Aguardando Reserva"
- [ ] Criar reserva de sala
- [ ] Clicar "Preencher com evento" no formul√°rio
- [ ] Campos s√£o preenchidos automaticamente
- [ ] Admin aprovar reserva
- [ ] Em EntidadeDetalhes, ver tabs separadas
- [ ] Tab Eventos mostra evento com badge
- [ ] Clicar "Vincular a Reserva"
- [ ] Selecionar reserva aprovada
- [ ] Confirmar vincula√ß√£o
- [ ] Badge muda para "Evento Ativo"
- [ ] Evento continua aparecendo publicamente
- [ ] Clicar "Gerenciar Vincula√ß√£o"
- [ ] Desvincular evento
- [ ] Reserva volta para "Dispon√≠vel"
- [ ] Evento volta para "Aguardando Reserva"
- [ ] Vincular novamente a outra reserva

## üìÅ ARQUIVOS CRIADOS/MODIFICADOS

### Criados:
1. `supabase/migrations/20250110_add_reserva_id_to_eventos.sql`
2. `apply-separar-eventos-reservas.sql`
3. `src/hooks/useVincularEventoReserva.ts`
4. `src/hooks/useEventosSemReserva.ts`
5. `src/hooks/useReservasSemEvento.ts`
6. `src/components/VincularEventoReserva.tsx`
7. `src/components/PreencherReservaComEvento.tsx`
8. `src/components/EventosReservasTabsEntidade.tsx`
9. `src/lib/evento-reserva-status.tsx`
10. Documenta√ß√£o:
    - `IMPLEMENTACAO-SEPARACAO-EVENTOS-RESERVAS.md`
    - `PROXIMOS-PASSOS-MANUAL.md`
    - `GUIA-INTEGRACAO-TABS-ENTIDADE.md`
    - `RESUMO-IMPLEMENTACAO-FINAL.md`

### Modificados:
1. `src/components/ReservaSalaFormV2.tsx` - Adicionado PreencherReservaComEvento
2. `src/components/ReservaAuditorioFormV3.tsx` - Adicionado PreencherReservaComEvento
3. `src/components/CriarEventoEntidade.tsx` - Adicionado switch "precisa espa√ßo f√≠sico"
4. `src/hooks/useEventos.ts` - Filtro de visibilidade aplicado

### Pendentes de Modifica√ß√£o Manual:
1. `src/pages/EntidadeDetalhes.tsx` - Integrar EventosReservasTabsEntidade (guia fornecido)

## ‚ö° QUICK START

### Para come√ßar a usar AGORA:

1. **Execute no Supabase Dashboard SQL Editor:**
   ```sql
   -- Copie e execute: apply-separar-eventos-reservas.sql
   -- Copie e execute: fix-aprovar-evento-final.sql
   ```

2. **Teste criar evento sem reserva:**
   - Login como entidade
   - Criar evento
   - Desmarcar "precisa espa√ßo f√≠sico"
   - Admin aprovar
   - Verificar que aparece publicamente

3. **Teste preencher reserva com evento:**
   - Criar reserva de sala
   - No step 1, ver card azul "Preencher com evento"
   - Selecionar evento e clicar "Aplicar"
   - Ver campos preenchidos

4. **Integrar tabs no EntidadeDetalhes:**
   - Seguir `GUIA-INTEGRACAO-TABS-ENTIDADE.md`
   - Adicionar import
   - Substituir Card de Eventos
   - Testar vincula√ß√£o

## üéâ RESULTADO FINAL

Ap√≥s todas as implementa√ß√µes:

‚úÖ Reservas e eventos s√£o entidades independentes
‚úÖ Admin aprova cada um separadamente
‚úÖ Entidades podem criar eventos sem reserva (online/externos)
‚úÖ Entidades podem preencher reservas rapidamente com dados de eventos
‚úÖ Sistema de vincula√ß√£o bidirecional flex√≠vel
‚úÖ Reservas podem ser trocadas entre eventos
‚úÖ Badges visuais claros de status
‚úÖ Regra de visibilidade p√∫blica aplicada corretamente
‚úÖ Backward compatibility mantida (fluxo antigo funciona)
‚úÖ UX melhorada com tabs e organiza√ß√£o clara

## üîë PONTOS-CHAVE

1. **Eventos sem reserva s√£o permitidos** (online/externos)
2. **Eventos com reserva pendente N√ÉO aparecem publicamente**
3. **Reservas livres podem ser vinculadas a m√∫ltiplos eventos** (uma de cada vez)
4. **Fluxo antigo continua funcionando** (criar evento de reserva)
5. **Admin tem controle total** (aprova eventos e reservas separadamente)
6. **Entidades t√™m flexibilidade** (podem criar na ordem que preferirem)

## üìû SUPORTE

Se encontrar problemas:

1. Verificar se migra√ß√µes SQL foram executadas com sucesso
2. Verificar console do navegador para erros
3. Verificar pol√≠ticas RLS no Supabase Dashboard
4. Limpar cache do navegador (Ctrl+Shift+Del)
5. Ver documenta√ß√£o detalhada nos arquivos MD criados

## üöÄ PR√ìXIMA FUNCIONALIDADE SUGERIDA

Ap√≥s implementar e testar, considere adicionar:

- [ ] Valida√ß√£o de conflitos de hor√°rio ao vincular
- [ ] Valida√ß√£o de capacidade (evento <= sala)
- [ ] Hist√≥rico de vincula√ß√µes
- [ ] Notifica√ß√µes ao vincular/desvincular
- [ ] Filtros avan√ßados nas tabs
- [ ] Exporta√ß√£o de dados

