<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Processamento de Hor치rio</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .input-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>游댢 Debug - Processamento de Hor치rio</h1>
        
        <div class="section">
            <h2>1. Configura칞칚o do Supabase</h2>
            <div class="input-group">
                <label>URL do Supabase:</label>
                <input type="text" id="supabaseUrl" placeholder="https://seu-projeto.supabase.co">
            </div>
            <div class="input-group">
                <label>Chave Anon:</label>
                <input type="text" id="supabaseKey" placeholder="sua-chave-anon">
            </div>
            <button onclick="testarConexao()">Testar Conex칚o</button>
            <div id="conexaoResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2. Buscar Eventos Existentes</h2>
            <button onclick="buscarEventos()">Buscar Eventos</button>
            <div id="eventosResult" class="result"></div>
        </div>

        <div class="section">
            <h2>3. Testar Atualiza칞칚o de Hor치rio</h2>
            <div class="input-group">
                <label>ID do Evento:</label>
                <input type="text" id="eventoId" placeholder="uuid-do-evento">
            </div>
            <div class="input-group">
                <label>ID da Entidade:</label>
                <input type="number" id="entidadeId" placeholder="1">
            </div>
            <div class="input-group">
                <label>Data e Hora (datetime-local):</label>
                <input type="datetime-local" id="dataHora" value="2024-02-15T15:30">
            </div>
            <div class="input-group">
                <label>Nome do Evento:</label>
                <input type="text" id="nomeEvento" value="Teste Hor치rio Debug">
            </div>
            <button onclick="testarAtualizacao()">Testar Atualiza칞칚o</button>
            <div id="atualizacaoResult" class="result"></div>
        </div>

        <div class="section">
            <h2>4. Verificar Resultado</h2>
            <button onclick="verificarResultado()">Verificar Evento Atualizado</button>
            <div id="verificacaoResult" class="result"></div>
        </div>

        <div class="section">
            <h2>5. Debug de Convers칚o de Data</h2>
            <div class="input-group">
                <label>Data/Hora para Testar:</label>
                <input type="datetime-local" id="dataTeste" value="2024-02-15T15:30">
            </div>
            <button onclick="testarConversao()">Testar Convers칚o</button>
            <div id="conversaoResult" class="result"></div>
        </div>
    </div>

    <script>
        let supabase;

        function testarConexao() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                mostrarResultado('conexaoResult', 'Preencha URL e chave do Supabase', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                mostrarResultado('conexaoResult', 'Conex칚o estabelecida com sucesso!', 'success');
            } catch (error) {
                mostrarResultado('conexaoResult', 'Erro na conex칚o: ' + error.message, 'error');
            }
        }

        async function buscarEventos() {
            if (!supabase) {
                mostrarResultado('eventosResult', 'Configure a conex칚o primeiro', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('eventos')
                    .select('id, nome, data, horario, entidade_id, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                let html = '<h3>Eventos Encontrados:</h3>';
                data.forEach(evento => {
                    html += `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0;">
                            <strong>ID:</strong> ${evento.id}<br>
                            <strong>Nome:</strong> ${evento.nome}<br>
                            <strong>Data:</strong> ${evento.data}<br>
                            <strong>Hor치rio:</strong> ${evento.horario || 'NULL'}<br>
                            <strong>Entidade ID:</strong> ${evento.entidade_id}<br>
                            <strong>Criado:</strong> ${new Date(evento.created_at).toLocaleString()}
                        </div>
                    `;
                });

                mostrarResultado('eventosResult', html, 'success');
            } catch (error) {
                mostrarResultado('eventosResult', 'Erro ao buscar eventos: ' + error.message, 'error');
            }
        }

        async function testarAtualizacao() {
            if (!supabase) {
                mostrarResultado('atualizacaoResult', 'Configure a conex칚o primeiro', 'error');
                return;
            }

            const eventoId = document.getElementById('eventoId').value;
            const entidadeId = document.getElementById('entidadeId').value;
            const dataHora = document.getElementById('dataHora').value;
            const nomeEvento = document.getElementById('nomeEvento').value;

            if (!eventoId || !entidadeId || !dataHora) {
                mostrarResultado('atualizacaoResult', 'Preencha todos os campos obrigat칩rios', 'error');
                return;
            }

            try {
                // Converter para ISO string
                const dataEventoProcessada = new Date(dataHora).toISOString();
                
                mostrarResultado('atualizacaoResult', `
                    <h3>Dados sendo enviados:</h3>
                    <strong>Evento ID:</strong> ${eventoId}<br>
                    <strong>Entidade ID:</strong> ${entidadeId}<br>
                    <strong>Data/Hora Original:</strong> ${dataHora}<br>
                    <strong>Data/Hora Processada:</strong> ${dataEventoProcessada}<br>
                    <strong>Nome:</strong> ${nomeEvento}
                `, 'success');

                const { data, error } = await supabase.rpc('update_event_as_entity', {
                    _evento_id: eventoId,
                    _entidade_id: parseInt(entidadeId),
                    _nome: nomeEvento,
                    _descricao: 'Teste de processamento de hor치rio',
                    _local: 'Local de Teste',
                    _data_evento: dataEventoProcessada,
                    _capacidade: 25
                });

                if (error) throw error;

                mostrarResultado('atualizacaoResult', `
                    <h3>Atualiza칞칚o Realizada!</h3>
                    <strong>Resultado:</strong> ${data}<br>
                    <strong>Status:</strong> Sucesso
                `, 'success');
            } catch (error) {
                mostrarResultado('atualizacaoResult', 'Erro na atualiza칞칚o: ' + error.message, 'error');
            }
        }

        async function verificarResultado() {
            if (!supabase) {
                mostrarResultado('verificacaoResult', 'Configure a conex칚o primeiro', 'error');
                return;
            }

            const nomeEvento = document.getElementById('nomeEvento').value;

            try {
                const { data, error } = await supabase
                    .from('eventos')
                    .select('id, nome, data, horario, updated_at')
                    .eq('nome', nomeEvento)
                    .order('updated_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data.length > 0) {
                    const evento = data[0];
                    mostrarResultado('verificacaoResult', `
                        <h3>Evento Atualizado:</h3>
                        <strong>ID:</strong> ${evento.id}<br>
                        <strong>Nome:</strong> ${evento.nome}<br>
                        <strong>Data:</strong> ${evento.data}<br>
                        <strong>Hor치rio:</strong> ${evento.horario || 'NULL'}<br>
                        <strong>Atualizado:</strong> ${new Date(evento.updated_at).toLocaleString()}
                    `, 'success');
                } else {
                    mostrarResultado('verificacaoResult', 'Evento n칚o encontrado', 'error');
                }
            } catch (error) {
                mostrarResultado('verificacaoResult', 'Erro ao verificar: ' + error.message, 'error');
            }
        }

        function testarConversao() {
            const dataTeste = document.getElementById('dataTeste').value;
            
            if (!dataTeste) {
                mostrarResultado('conversaoResult', 'Selecione uma data/hora', 'error');
                return;
            }

            try {
                const data = new Date(dataTeste);
                const isoString = data.toISOString();
                const dataOnly = data.toISOString().split('T')[0];
                const timeOnly = data.toTimeString().split(' ')[0];

                mostrarResultado('conversaoResult', `
                    <h3>Convers칚o de Data/Hora:</h3>
                    <strong>Input:</strong> ${dataTeste}<br>
                    <strong>Date Object:</strong> ${data.toString()}<br>
                    <strong>ISO String:</strong> ${isoString}<br>
                    <strong>Data Apenas:</strong> ${dataOnly}<br>
                    <strong>Hor치rio Apenas:</strong> ${timeOnly}<br>
                    <strong>Timezone:</strong> ${data.getTimezoneOffset()} minutos
                `, 'success');
            } catch (error) {
                mostrarResultado('conversaoResult', 'Erro na convers칚o: ' + error.message, 'error');
            }
        }

        function mostrarResultado(elementId, mensagem, tipo) {
            const element = document.getElementById(elementId);
            element.innerHTML = mensagem;
            element.className = 'result ' + tipo;
        }
    </script>
</body>
</html> 