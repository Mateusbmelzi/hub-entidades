<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Problema do Dia a Menos</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .input-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        .debug-info { background: #e3f2fd; color: #1565c0; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Problema do Dia a Menos</h1>
        
        <div class="section">
            <h2>1. Configura√ß√£o do Supabase</h2>
            <div class="input-group">
                <label>URL do Supabase:</label>
                <input type="text" id="supabaseUrl" placeholder="https://seu-projeto.supabase.co">
            </div>
            <div class="input-group">
                <label>Chave Anon:</label>
                <input type="text" id="supabaseKey" placeholder="sua-chave-anon">
            </div>
            <button onclick="testarConexao()">Testar Conex√£o</button>
            <div id="conexaoResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2. Teste de Convers√£o de Data</h2>
            <div class="input-group">
                <label>Data/Hora para Testar (datetime-local):</label>
                <input type="datetime-local" id="dataTeste" value="2024-02-06T15:30">
            </div>
            <button onclick="testarConversaoDetalhada()">Testar Convers√£o Detalhada</button>
            <div id="conversaoResult" class="result"></div>
        </div>

        <div class="section">
            <h2>3. Teste Direto no Banco (UPDATE)</h2>
            <div class="input-group">
                <label>ID do Evento:</label>
                <input type="text" id="eventoId" placeholder="uuid-do-evento">
            </div>
            <div class="input-group">
                <label>Data/Hora para Testar:</label>
                <input type="datetime-local" id="dataBanco" value="2024-02-06T15:30">
            </div>
            <button onclick="testarUpdateDireto()">Testar UPDATE Direto</button>
            <div id="updateResult" class="result"></div>
        </div>

        <div class="section">
            <h2>4. Teste da Fun√ß√£o RPC</h2>
            <div class="input-group">
                <label>ID do Evento:</label>
                <input type="text" id="eventoIdRpc" placeholder="uuid-do-evento">
            </div>
            <div class="input-group">
                <label>ID da Entidade:</label>
                <input type="number" id="entidadeId" placeholder="1">
            </div>
            <div class="input-group">
                <label>Data/Hora para Testar:</label>
                <input type="datetime-local" id="dataRpc" value="2024-02-06T15:30">
            </div>
            <button onclick="testarFuncaoRpc()">Testar Fun√ß√£o RPC</button>
            <div id="rpcResult" class="result"></div>
        </div>

        <div class="section">
            <h2>5. Compara√ß√£o de Resultados</h2>
            <button onclick="compararResultados()">Comparar Resultados</button>
            <div id="comparacaoResult" class="result"></div>
        </div>

        <div class="section">
            <h2>6. Verificar Eventos Recentes</h2>
            <button onclick="verificarEventos()">Verificar Eventos</button>
            <div id="eventosResult" class="result"></div>
        </div>
    </div>

    <script>
        let supabase;
        let resultados = {};

        function testarConexao() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                mostrarResultado('conexaoResult', 'Preencha URL e chave do Supabase', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                mostrarResultado('conexaoResult', 'Conex√£o estabelecida com sucesso!', 'success');
            } catch (error) {
                mostrarResultado('conexaoResult', 'Erro na conex√£o: ' + error.message, 'error');
            }
        }

        function testarConversaoDetalhada() {
            const dataTeste = document.getElementById('dataTeste').value;
            
            if (!dataTeste) {
                mostrarResultado('conversaoResult', 'Selecione uma data/hora', 'error');
                return;
            }

            try {
                // M√©todo 1: Usar diretamente a string
                const metodo1 = dataTeste + ':00';
                
                // M√©todo 2: Criar Date e extrair componentes
                const dataObj = new Date(dataTeste);
                const ano = dataObj.getFullYear();
                const mes = String(dataObj.getMonth() + 1).padStart(2, '0');
                const dia = String(dataObj.getDate()).padStart(2, '0');
                const hora = String(dataObj.getHours()).padStart(2, '0');
                const minuto = String(dataObj.getMinutes()).padStart(2, '0');
                const segundo = String(dataObj.getSeconds()).padStart(2, '0');
                const metodo2 = `${ano}-${mes}-${dia}T${hora}:${minuto}:${segundo}`;
                
                // M√©todo 3: toISOString
                const metodo3 = dataObj.toISOString();
                
                // M√©todo 4: toISOString sem timezone
                const metodo4 = dataObj.toISOString().slice(0, 19);

                let html = `
                    <h3>Convers√£o de Data/Hora Detalhada:</h3>
                    <div class="debug-info">
                        <strong>Input Original:</strong> ${dataTeste}<br>
                        <strong>Date Object:</strong> ${dataObj.toString()}<br>
                        <strong>Timezone Offset:</strong> ${dataObj.getTimezoneOffset()} minutos<br>
                        <strong>UTC Time:</strong> ${dataObj.toUTCString()}<br>
                    </div>
                    
                    <h4>M√©todos de Convers√£o:</h4>
                    <div class="debug-info">
                        <strong>M√©todo 1 (String direta):</strong> ${metodo1}<br>
                        <strong>M√©todo 2 (Componentes):</strong> ${metodo2}<br>
                        <strong>M√©todo 3 (toISOString):</strong> ${metodo3}<br>
                        <strong>M√©todo 4 (toISOString sem TZ):</strong> ${metodo4}<br>
                    </div>
                `;

                resultados.conversao = {
                    input: dataTeste,
                    metodo1,
                    metodo2,
                    metodo3,
                    metodo4
                };

                mostrarResultado('conversaoResult', html, 'success');
            } catch (error) {
                mostrarResultado('conversaoResult', 'Erro na convers√£o: ' + error.message, 'error');
            }
        }

        async function testarUpdateDireto() {
            if (!supabase) {
                mostrarResultado('updateResult', 'Configure a conex√£o primeiro', 'error');
                return;
            }

            const eventoId = document.getElementById('eventoId').value;
            const dataBanco = document.getElementById('dataBanco').value;
            
            if (!eventoId || !dataBanco) {
                mostrarResultado('updateResult', 'Preencha todos os campos', 'error');
                return;
            }

            try {
                // Primeiro, vamos ver o evento atual
                const { data: eventoAtual, error: errorAtual } = await supabase
                    .from('eventos')
                    .select('id, nome, data, horario, updated_at')
                    .eq('id', eventoId)
                    .single();

                if (errorAtual) throw errorAtual;

                // Separar data e hor√°rio manualmente
                const dataString = dataBanco + ':00';
                const dataObj = new Date(dataString);
                const dataOnly = dataObj.toISOString().split('T')[0];
                const timeOnly = dataObj.toTimeString().split(' ')[0];

                // Fazer UPDATE direto
                const { data: updateData, error: updateError } = await supabase
                    .from('eventos')
                    .update({
                        data: dataOnly,
                        horario: timeOnly,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', eventoId)
                    .select('id, nome, data, horario, updated_at');

                if (updateError) throw updateError;

                // Verificar resultado
                const { data: eventoDepois, error: errorDepois } = await supabase
                    .from('eventos')
                    .select('id, nome, data, horario, updated_at')
                    .eq('id', eventoId)
                    .single();

                if (errorDepois) throw errorDepois;

                let html = `
                    <h3>Teste UPDATE Direto:</h3>
                    <div class="debug-info">
                        <strong>Input:</strong> ${dataBanco}<br>
                        <strong>Data Processada:</strong> ${dataOnly}<br>
                        <strong>Hor√°rio Processado:</strong> ${timeOnly}<br>
                    </div>
                    
                    <h4>Antes do UPDATE:</h4>
                    <div class="debug-info">
                        <strong>Data:</strong> ${eventoAtual.data}<br>
                        <strong>Hor√°rio:</strong> ${eventoAtual.horario || 'NULL'}<br>
                    </div>
                    
                    <h4>Depois do UPDATE:</h4>
                    <div class="debug-info">
                        <strong>Data:</strong> ${eventoDepois.data}<br>
                        <strong>Hor√°rio:</strong> ${eventoDepois.horario || 'NULL'}<br>
                        <strong>Atualizado:</strong> ${new Date(eventoDepois.updated_at).toLocaleString()}<br>
                    </div>
                `;

                resultados.updateDireto = {
                    input: dataBanco,
                    dataProcessada: dataOnly,
                    horarioProcessado: timeOnly,
                    antes: eventoAtual,
                    depois: eventoDepois
                };

                mostrarResultado('updateResult', html, 'success');
            } catch (error) {
                mostrarResultado('updateResult', 'Erro no UPDATE: ' + error.message, 'error');
            }
        }

        async function testarFuncaoRpc() {
            if (!supabase) {
                mostrarResultado('rpcResult', 'Configure a conex√£o primeiro', 'error');
                return;
            }

            const eventoId = document.getElementById('eventoIdRpc').value;
            const entidadeId = document.getElementById('entidadeId').value;
            const dataRpc = document.getElementById('dataRpc').value;
            
            if (!eventoId || !entidadeId || !dataRpc) {
                mostrarResultado('rpcResult', 'Preencha todos os campos', 'error');
                return;
            }

            try {
                // Primeiro, vamos ver o evento atual
                const { data: eventoAtual, error: errorAtual } = await supabase
                    .from('eventos')
                    .select('id, nome, data, horario, updated_at')
                    .eq('id', eventoId)
                    .single();

                if (errorAtual) throw errorAtual;

                // Preparar dados para RPC
                const dataString = dataRpc + ':00';

                // Chamar fun√ß√£o RPC
                const { data: rpcResult, error: rpcError } = await supabase.rpc('update_event_as_entity', {
                    _evento_id: eventoId,
                    _entidade_id: parseInt(entidadeId),
                    _nome: 'Teste RPC - ' + new Date().toLocaleTimeString(),
                    _descricao: 'Teste de fun√ß√£o RPC',
                    _local: 'Local Teste',
                    _data_evento: dataString,
                    _capacidade: 25
                });

                if (rpcError) throw rpcError;

                // Verificar resultado
                const { data: eventoDepois, error: errorDepois } = await supabase
                    .from('eventos')
                    .select('id, nome, data, horario, updated_at')
                    .eq('id', eventoId)
                    .single();

                if (errorDepois) throw errorDepois;

                let html = `
                    <h3>Teste Fun√ß√£o RPC:</h3>
                    <div class="debug-info">
                        <strong>Input:</strong> ${dataRpc}<br>
                        <strong>Enviado para RPC:</strong> ${dataString}<br>
                        <strong>Resultado RPC:</strong> ${rpcResult}<br>
                    </div>
                    
                    <h4>Antes do RPC:</h4>
                    <div class="debug-info">
                        <strong>Data:</strong> ${eventoAtual.data}<br>
                        <strong>Hor√°rio:</strong> ${eventoAtual.horario || 'NULL'}<br>
                    </div>
                    
                    <h4>Depois do RPC:</h4>
                    <div class="debug-info">
                        <strong>Data:</strong> ${eventoDepois.data}<br>
                        <strong>Hor√°rio:</strong> ${eventoDepois.horario || 'NULL'}<br>
                        <strong>Atualizado:</strong> ${new Date(eventoDepois.updated_at).toLocaleString()}<br>
                    </div>
                `;

                resultados.rpc = {
                    input: dataRpc,
                    enviado: dataString,
                    resultado: rpcResult,
                    antes: eventoAtual,
                    depois: eventoDepois
                };

                mostrarResultado('rpcResult', html, 'success');
            } catch (error) {
                mostrarResultado('rpcResult', 'Erro na fun√ß√£o RPC: ' + error.message, 'error');
            }
        }

        function compararResultados() {
            let html = '<h3>Compara√ß√£o de Resultados:</h3>';
            
            if (resultados.updateDireto && resultados.rpc) {
                const update = resultados.updateDireto;
                const rpc = resultados.rpc;
                
                html += `
                    <div class="debug-info">
                        <h4>UPDATE Direto vs Fun√ß√£o RPC:</h4>
                        <strong>Input Original:</strong> ${update.input} vs ${rpc.input}<br>
                        <strong>Data Salva (UPDATE):</strong> ${update.depois.data}<br>
                        <strong>Data Salva (RPC):</strong> ${rpc.depois.data}<br>
                        <strong>Hor√°rio Salvo (UPDATE):</strong> ${update.depois.horario || 'NULL'}<br>
                        <strong>Hor√°rio Salvo (RPC):</strong> ${rpc.depois.horario || 'NULL'}<br>
                    </div>
                `;
                
                // Verificar se h√° diferen√ßa
                if (update.depois.data !== rpc.depois.data) {
                    html += '<div class="warning"><strong>‚ö†Ô∏è DIFEREN√áA ENCONTRADA!</strong> As datas salvas s√£o diferentes!</div>';
                } else {
                    html += '<div class="success"><strong>‚úÖ DATAS IGUAIS</strong> Ambos os m√©todos salvaram a mesma data.</div>';
                }
            } else {
                html += '<div class="warning">Execute primeiro os testes de UPDATE direto e RPC para comparar.</div>';
            }
            
            mostrarResultado('comparacaoResult', html, 'success');
        }

        async function verificarEventos() {
            if (!supabase) {
                mostrarResultado('eventosResult', 'Configure a conex√£o primeiro', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('eventos')
                    .select('id, nome, data, horario, created_at, updated_at')
                    .order('updated_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let html = '<h3>Eventos Recentes:</h3>';
                data.forEach(evento => {
                    html += `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 5px 0;">
                            <strong>ID:</strong> ${evento.id}<br>
                            <strong>Nome:</strong> ${evento.nome}<br>
                            <strong>Data:</strong> ${evento.data}<br>
                            <strong>Hor√°rio:</strong> ${evento.horario || 'NULL'}<br>
                            <strong>Criado:</strong> ${new Date(evento.created_at).toLocaleString()}<br>
                            <strong>Atualizado:</strong> ${new Date(evento.updated_at).toLocaleString()}<br>
                        </div>
                    `;
                });

                mostrarResultado('eventosResult', html, 'success');
            } catch (error) {
                mostrarResultado('eventosResult', 'Erro ao buscar eventos: ' + error.message, 'error');
            }
        }

        function mostrarResultado(elementId, mensagem, tipo) {
            const element = document.getElementById(elementId);
            element.innerHTML = mensagem;
            element.className = 'result ' + tipo;
        }
    </script>
</body>
</html> 