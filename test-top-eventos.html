<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Top Eventos</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f5f5f5; font-weight: bold; }
        .loading { color: #666; font-style: italic; }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; }
        .success { color: #2e7d32; background: #e8f5e8; padding: 10px; border-radius: 4px; }
        .ranking { font-weight: bold; }
        .gold { color: #ffd700; }
        .silver { color: #c0c0c0; }
        .bronze { color: #cd7f32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Teste da Tabela Top Eventos</h1>
        <p>Este teste verifica se a tabela <code>top_eventos</code> est√° funcionando no Supabase.</p>
        
        <div id="status"></div>
        <div id="results"></div>
        
        <button onclick="testTopEventos()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üîç Testar Tabela Top Eventos
        </button>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://lddtackcnpzdswndqgfs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkZHRhY2tjbnB6ZHN3bmRxZ2ZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTY5MDgsImV4cCI6MjA2Njk3MjkwOH0.NPN6E-4RttputzXcVavoOTRGiM9c3T5bLaLPTtJJM4s';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function testTopEventos() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = '<div class="loading">üîÑ Testando conex√£o com a tabela top_eventos...</div>';
            resultsDiv.innerHTML = '';

            try {
                // Teste 1: Verificar se a tabela existe
                console.log('üîç Testando tabela top_eventos...');
                
                const { data, error } = await supabase
                    .from('top_eventos')
                    .select('*')
                    .order('total_inscricoes', { ascending: false })
                    .limit(10);

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Dados recebidos:', data);
                
                if (data && data.length > 0) {
                    statusDiv.innerHTML = '<div class="success">‚úÖ Tabela top_eventos funcionando! Encontrados ' + data.length + ' eventos.</div>';
                    displayResults(data);
                } else {
                    statusDiv.innerHTML = '<div class="success">‚úÖ Tabela top_eventos existe, mas n√£o possui dados ainda.</div>';
                    resultsDiv.innerHTML = '<p>üìù A tabela est√° vazia. Isso pode significar que:</p><ul><li>N√£o h√° eventos cadastrados</li><li>A fun√ß√£o RPC que popula a tabela n√£o foi executada</li><li>Os dados ainda n√£o foram processados</li></ul>';
                }

            } catch (error) {
                console.error('‚ùå Erro:', error);
                statusDiv.innerHTML = '<div class="error">‚ùå Erro ao acessar tabela top_eventos: ' + error.message + '</div>';
                
                if (error.message.includes('relation "top_eventos" does not exist')) {
                    resultsDiv.innerHTML = `
                        <h3>üîß Solu√ß√£o: Criar a tabela top_eventos</h3>
                        <p>A tabela <code>top_eventos</code> n√£o existe. Voc√™ precisa:</p>
                        <ol>
                            <li>Criar a tabela no Supabase</li>
                            <li>Criar uma fun√ß√£o RPC para popular os dados</li>
                            <li>Executar a fun√ß√£o para gerar os dados</li>
                        </ol>
                        <h4>SQL para criar a tabela:</h4>
                        <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto;">
CREATE TABLE top_eventos (
    id SERIAL PRIMARY KEY,
    nome_evento TEXT NOT NULL,
    total_inscricoes BIGINT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);</pre>
                    `;
                } else if (error.message.includes('permission denied')) {
                    resultsDiv.innerHTML = '<p>üîí Erro de permiss√£o. Verifique as pol√≠ticas de seguran√ßa da tabela.</p>';
                } else {
                    resultsDiv.innerHTML = '<p>‚ö†Ô∏è Erro inesperado. Verifique o console para mais detalhes.</p>';
                }
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            
            let html = '<h3>üèÜ Top Eventos Encontrados</h3>';
            html += '<table>';
            html += '<thead><tr><th>#</th><th>Nome do Evento</th><th>Total de Inscri√ß√µes</th><th>Ranking</th></tr></thead>';
            html += '<tbody>';
            
            data.forEach((evento, index) => {
                const ranking = getRankingBadge(index);
                html += `
                    <tr>
                        <td class="ranking">${index + 1}</td>
                        <td>${evento.nome_evento}</td>
                        <td><strong>${evento.total_inscricoes.toLocaleString('pt-BR')}</strong></td>
                        <td>${ranking}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            html += '<h4>üìä Estrutura dos Dados</h4>';
            html += '<ul>';
            html += '<li><strong>Total de eventos:</strong> ' + data.length + '</li>';
            html += '<li><strong>Evento com mais inscri√ß√µes:</strong> ' + data[0]?.nome_evento + ' (' + data[0]?.total_inscricoes + ' inscri√ß√µes)</li>';
            html += '<li><strong>Evento com menos inscri√ß√µes:</strong> ' + data[data.length - 1]?.nome_evento + ' (' + data[data.length - 1]?.total_inscricoes + ' inscri√ß√µes)</li>';
            html += '</ul>';
            
            resultsDiv.innerHTML = html;
        }

        function getRankingBadge(index) {
            if (index === 0) return '<span class="gold">ü•á 1¬∫ Lugar</span>';
            if (index === 1) return '<span class="silver">ü•à 2¬∫ Lugar</span>';
            if (index === 2) return '<span class="bronze">ü•â 3¬∫ Lugar</span>';
            return '<span>' + (index + 1) + '¬∫ Lugar</span>';
        }

        // Teste autom√°tico ao carregar a p√°gina
        window.onload = function() {
            console.log('üöÄ P√°gina carregada, iniciando teste autom√°tico...');
            setTimeout(testTopEventos, 1000);
        };
    </script>
</body>
</html>
